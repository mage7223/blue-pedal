<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        const serviceUUID = "d98e357f-3d21-4669-a17d-9b389d6559e1";
        const buttonDownCharacteristicUUID = "4e9ca473-b618-4de5-a0db-bb1c055a5e1c";
        const buttonUpCharacteristicUUID = "019f2af2-6401-445b-a52d-8119aca2c5ef";
        function handleCharacteristicValueChanged(event) {
            const value = event.target.value;
            const textDecoder = new TextDecoder();
            const serialData = textDecoder.decode(value);
            console.log('Serial data received:', serialData);
        };
        function handleCharacteristicValueDownChanged(event) {
            const value = event.target.value;
            const textDecoder = new TextDecoder();
            const serialData = textDecoder.decode(value);
            console.log('Serial data received:', serialData);
        };
        function handleCharacteristicValueUpChanged(event) {
            const value = event.target.value;
            const textDecoder = new TextDecoder();
            const serialData = textDecoder.decode(value);
            console.log('Serial data received:', serialData);
        };

// TODO: Server is disconnecting after a while. Need to investigate further.
    $(document).ready(function() {
        $('#findDevices').click(async function() {
            try {
                const device = await navigator.bluetooth.requestDevice(
                    { filters:[ {services:[serviceUUID]} ] }
                );
                
                var server;
                var service;
                var buttonDownCharacteristic;
                var buttonUpCharacteristic;
                device.addEventListener('gattserverdisconnected', () => {
                    console.log('Device disconnected');
                });
                device.addEventListener('gattserverconnected', () => {
                    console.log('Device connected');
                });
                device.gatt.connect()
                .then(connectedServer => {
                    console.log('Connected to GATT server');
                    server = connectedServer;
                    return connectedServer.getPrimaryService(serviceUUID);
                })
                .then(connectedService => {
                    return Promise.all([
                        connectedService.getCharacteristic(buttonDownCharacteristicUUID),
                        connectedService.getCharacteristic(buttonUpCharacteristicUUID)
                    ]);
                }).then(characteristics => {
                    [buttonDownCharacteristic, buttonUpCharacteristic] = characteristics;
                    console.log('Characteristics obtained:', buttonDownCharacteristic, buttonUpCharacteristic);
                    buttonDownCharacteristic.startNotifications().then(() => {
                        buttonDownCharacteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueDownChanged);
                        console.log('Notifications started for button down characteristic');
                    });
                    buttonUpCharacteristic.startNotifications().then(() => {
                        buttonUpCharacteristic.addEventListener('characteristicvaluechanged', handleCharacteristicValueUpChanged);
                        console.log('Notifications started for button up characteristic');
                    });
                    
                })
                .catch(error => {
                    console.error('Error during GATT operations:', error);
                });

            } catch (error) {
                console.error('Error finding Bluetooth devices:', error);
            }
        });
    });
    </script>
    <title>Document</title>
</head>
<body>
    
    <button id="findDevices">Find Bluetooth Devices</button>

</body>
</html>